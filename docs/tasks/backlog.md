---
category: backlog
status: in_progress
updated: 2025-10-24
---

# 残課題バックログ

> **備考:** OPS 系・DOC 系を含む複数タスクが同一ファイルで並行管理されているため、更新時は備考欄の追従状況を必ず確認する。

<!-- markdownlint-disable MD013 MD033 MD056 MD058 MD032 -->

| 状態 | ID (ユニーク) | 要約 | 対象領域 | 完了条件 | 備考 | 先行着手タスク |
|:----:|:-------------|:-----|:---------|:---------|:-----|:----------------|
| [x] | OPS-B01 | Permit/ジッタ/バッチ閾値の運用チューニング | `config/settings.example.json` 系列<br>`src/llm_generic_bot/core/scheduler.py`<br>`src/llm_generic_bot/core/arbiter.py` | `pytest tests/integration/test_runtime_multicontent_failures.py -q`・`pytest tests/infra/metrics/test_send_delay_thresholds.py -q`・`mypy src/llm_generic_bot/core/scheduler.py src/llm_generic_bot/core/arbiter.py`・`ruff check src/llm_generic_bot/core/scheduler.py src/llm_generic_bot/core/arbiter.py` を通過させ、閾値変更後もメトリクス揺らぎが許容範囲内であることを確認する。 | 2025-10-24: ジッタ範囲とバッチ閾値の調整を完了。`tests/infra/metrics/test_send_delay_thresholds.py` と `tests/integration/test_runtime_multicontent_failures.py` が現行 `src/llm_generic_bot/infra/metrics/aggregator_*.py` と整合し、遅延メトリクスが閾値内に収束することを確認済み。 | [OPS-08] ジッタ境界テスト済み。 |
| [x] | OPS-B02 | Permit 失敗時の再評価フロー整備 | `src/llm_generic_bot/core/orchestrator/__init__.py`（公開 API エントリ再輸出。旧 `core/orchestrator.py` は撤去済み）<br>`src/llm_generic_bot/core/orchestrator/processor.py`（再評価制御ロジック）<br>`src/llm_generic_bot/core/orchestrator_metrics.py` (メトリクス境界更新時の参照先)<br>`src/llm_generic_bot/core/arbiter.py`<br>`tests/integration/` | `pytest tests/integration/test_runtime_multicontent_failures.py -k permit -q`・`mypy src/llm_generic_bot/core/orchestrator`・`ruff check src/llm_generic_bot/core/orchestrator` を完走し、Permit 再評価待ちキュー投入と再送メトリクス記録を整備する。 | 2025-10-24: 監査ログと再試行理由タグを固定。`tests/integration/test_runtime_multicontent_failures.py` の Permit 経路と `tests/infra/metrics/test_send_delay_thresholds.py` による再送メトリクス検証が `src/llm_generic_bot/infra/metrics/aggregator_*.py` の集計と一致し、再評価フローを完了扱いとした。 | [OPS-10] Permit 拒否メトリクス取得済み。 |
| [x] | OPS-B03 | Permit クォータ多段構成とバッチ再送ガード | `src/llm_generic_bot/core/arbiter.py`<br>`src/llm_generic_bot/core/queue.py`<br>`tests/core/`<br>`tests/integration/test_runtime_multicontent_failures.py` | `pytest tests/core/test_quota_gate.py -k multilayer -q`・`pytest tests/integration/test_runtime_multicontent_failures.py -k quota_multilayer -q`・`mypy src/llm_generic_bot/core/queue.py`・`ruff check src/llm_generic_bot/core/queue.py` を通過させ、多段クォータ導入後もバッチ再送ガードで二重送信を防ぐ。 | 2025-10-24: `CoalesceQueue` と `Scheduler` の pending ティア管理・`batch_id` 再利用抑止を確定し、`tests/integration/test_runtime_multicontent_failures.py`／`tests/infra/metrics/test_send_delay_thresholds.py` と `src/llm_generic_bot/infra/metrics/aggregator_*.py` の遅延集計が一致していることを確認済み。 | Sprint1 [SND-02] 残課題を引継ぎ。 |
| [x] | OPS-B04 | メトリクスレポートテスト分割への参照移行 | `tests/infra/metrics/recording/test_success_events.py`<br>`tests/infra/metrics/recording/test_delay_events.py`<br>`tests/infra/metrics/recording/test_failures.py`<br>`tests/infra/metrics/recording/test_permit_denials.py`<br>`tests/infra/metrics/recording/test_snapshot.py`<br>`docs/roadmap.md`<br>`docs/tasks/backlog.md` | 1. `tests/infra/metrics/recording/test_success_events.py`・`test_delay_events.py`・`test_failures.py`・`test_permit_denials.py`・`test_snapshot.py` へ検証観点を統一し、旧単一ファイル構成からの移行を完了する。<br>2. `pytest tests/infra/metrics/recording/test_success_events.py tests/infra/metrics/recording/test_delay_events.py tests/infra/metrics/recording/test_failures.py tests/infra/metrics/recording/test_permit_denials.py tests/infra/metrics/recording/test_snapshot.py -q` と `mypy`・`ruff` をグリーン化して分割テストを基準にする。<br>3. バックログとロードマップから旧構成の説明を削除し、新テスト群を前提とした移行完了手順を共有する。 | 2025-10-19: 分割テスト構成とドキュメント更新を確認。 | - |
| [x] | OPS-B01 | Permit/ジッタ/バッチ閾値の運用チューニング | `config/settings.example.json` 系列<br>`src/llm_generic_bot/core/scheduler.py`<br>`src/llm_generic_bot/core/arbiter.py` | テストを先に追加し、Permit/ジッタ/バッチ閾値を調整しても `pytest tests/integration/test_runtime_multicontent_failures.py -q` がグリーンであること、および遅延・Permit 通過率が期待値内に収束するメトリクス検証を `tests/infra/` 配下に追加する。 | 2025-10-24: `tests/infra/metrics/test_send_delay_thresholds.py` と `tests/integration/test_runtime_multicontent_failures.py` が `src/llm_generic_bot/infra/metrics/aggregator_*.py` の遅延集計と整合し、ジッタ揺らぎと Permit 通過率が期待値内に収束することを確認済み。 | [OPS-08] ジッタ境界テスト済み。 |
| [x] | OPS-B02 | Permit 失敗時の再評価フロー整備 | `src/llm_generic_bot/core/orchestrator/__init__.py`（公開 API エントリ再輸出。旧 `core/orchestrator.py` は撤去済み）<br>`src/llm_generic_bot/core/orchestrator/processor.py`（再評価制御ロジック）<br>`src/llm_generic_bot/core/orchestrator_metrics.py` (メトリクス境界更新時の参照先)<br>`src/llm_generic_bot/core/arbiter.py`<br>`tests/integration/` | Permit 拒否後の再評価タイミングをテストで固定し、再評価時にメトリクス/ログへ再試行理由を記録する。`pytest tests/integration/test_runtime_multicontent_failures.py -k permit -q` を新テストと併せてグリーン化する。 | 2025-10-24: `tests/integration/test_runtime_multicontent_failures.py::test_permit_denial_triggers_retry_window` ほか Permit 再評価経路と `tests/infra/metrics/test_send_delay_thresholds.py` の再送集計が `src/llm_generic_bot/infra/metrics/aggregator_*.py` のメトリクス整形と揃っていることを確認し、完了扱いへ更新。 | [OPS-10] Permit 拒否メトリクス取得済み。 |
| [x] | OPS-B03 | Permit クォータ多段構成とバッチ再送ガード | `src/llm_generic_bot/core/arbiter.py`<br>`src/llm_generic_bot/core/queue.py`<br>`tests/core/`<br>`tests/integration/test_runtime_multicontent_failures.py` | 多段クォータを導入するテストを先に追加し、再送ガードが二重送信を防ぎつつ `pytest tests/core/test_quota_gate.py -k multilayer -q` と `pytest tests/integration/test_runtime_multicontent_failures.py -k quota_multilayer -q` を通過させる。 | 2025-10-24: `tests/integration/test_runtime_multicontent_failures.py` の多段クォータ系シナリオと `tests/core/quota_gate/test_multitier.py` の再送ガード検証に加え、`tests/infra/metrics/test_send_delay_thresholds.py` の遅延監視が `src/llm_generic_bot/infra/metrics/aggregator_*.py` の集計結果と一致することを確認し、完了状態を維持。 | Sprint1 [SND-02] 残課題を引継ぎ。 |
| [x] | OPS-B04 | メトリクスレポートテスト分割への参照移行 | `tests/infra/metrics/recording/test_success_events.py`<br>`tests/infra/metrics/recording/test_delay_events.py`<br>`tests/infra/metrics/recording/test_failures.py`<br>`tests/infra/metrics/recording/test_permit_denials.py`<br>`tests/infra/metrics/recording/test_snapshot.py`<br>`docs/roadmap.md`<br>`docs/tasks/backlog.md` |
1. `tests/infra/metrics/recording/test_success_events.py`・`test_delay_events.py`・`test_failures.py`・`test_permit_denials.py`・`test_snapshot.py` へ検証観点を統一し、旧単一ファイル構成からの移行を完了する。<br>2. `pytest tests/infra/metrics/recording/test_success_events.py tests/infra/metrics/recording/test_delay_events.py tests/infra/metrics/recording/test_failures.py tests/infra/metrics/recording/test_permit_denials.py tests/infra/metrics/recording/test_snapshot.py -q` と `mypy`・`ruff` をグリーン化して分割テストを基準にする。<br>3. バックログとロードマップから旧構成の説明を削除し、新テスト群を前提とした移行完了手順を共有する。 | 2025-10-19: 分割テスト構成とドキュメント更新を確認。 | - |
| [x] | OPS-B05 | メトリクスレポート分割テストの撤去前チェック | `tests/infra/metrics/conftest.py`<br>`tests/infra/metrics/recording/test_success_events.py`<br>`tests/infra/metrics/recording/test_delay_events.py`<br>`tests/infra/metrics/recording/test_failures.py`<br>`tests/infra/metrics/recording/test_permit_denials.py`<br>`tests/infra/metrics/recording/test_snapshot.py`<br>`docs/` 全般 | 1. `rg "tests/infra/metrics/recording/test_"` を実行してコード/ドキュメントの参照が分割テストに統一されていることを確認する。<br>2. 分割テスト群を `pytest tests/infra/metrics/recording/test_success_events.py tests/infra/metrics/recording/test_delay_events.py tests/infra/metrics/recording/test_failures.py tests/infra/metrics/recording/test_permit_denials.py tests/infra/metrics/recording/test_snapshot.py -q` でグリーンにし、`mypy` と `ruff` も通過させる。<br>3. メトリクスレポート関連ガイドを分割テスト前提で更新し、撤去前チェック結果を記録する。 | 2025-10-19: 分割テストのみを基準にした撤去前確認を完了。 | OPS-B04 |
| [x] | OPS-B06 | `core/orchestrator/__init__.py` レガシーシム撤去 | `src/llm_generic_bot/core/orchestrator/__init__.py`<br>`tests/core/orchestrator*`<br>`tests/integration/*` | 1. 既存の直 import を新パスへ全て置換し、再輸出シムを廃止する。<br>2. `tests/core/orchestrator*` と `tests/integration/*` の参照を新パスへ更新し、必要なテストを先に追加して挙動を固定する。<br>3. CI (`pytest`, `mypy`, `ruff`) をグリーン化し、撤去後の回帰がないことを確認する。<br>4. バックログおよび関連ドキュメントへ移行完了手順と更新内容を反映する。 | 2025-10-19: `core/orchestrator/runtime.py` を公開実装として整備し、`tests/core/orchestrator/test_processor.py` と `tests/integration/test_orchestrator_imports.py` で新 import パスを固定化。`_legacy.py` はフォワーダのみとし、ロードマップへ移行手順を追記済み。 | OPS-B02 |
| [x] | OPS-B16 | メトリクス集計レコード分離と状態層整理 | `src/llm_generic_bot/infra/metrics/aggregator_state.py`<br>`src/llm_generic_bot/infra/metrics/aggregator_records.py`<br>`tests/infra/metrics/recording/test_success_events.py`<br>`tests/infra/metrics/recording/test_delay_events.py` | `_SendEventRecord` などの純粋関数を `aggregator_records.py` へ移し、`aggregator_state.py` はロック付き状態管理に専念。`pytest tests/infra/metrics/recording/test_success_events.py -q`・`pytest tests/infra/metrics/recording/test_delay_events.py -q`・`mypy src/llm_generic_bot/infra/metrics`・`ruff check src/llm_generic_bot/infra/metrics` を順に実行して回帰を防ぐ。 | 2025-10-24: 記録整形分離と retention 境界テストを完了し、`tests/infra/metrics/test_send_delay_thresholds.py` を含む遅延メトリクス経路が `src/llm_generic_bot/infra/metrics/aggregator_state.py`／`aggregator_records.py` と一致することを確認済み。`send.delay_seconds` の `unit="seconds"` タグも維持。 | OPS-B04/OPS-B05 完了後に実施。 |
| [x] | OPS-B07 | メトリクスレポート旧テスト完全撤去 | `tests/infra/metrics/recording/test_success_events.py`<br>`tests/infra/metrics/recording/test_delay_events.py`<br>`tests/infra/metrics/recording/test_failures.py`<br>`tests/infra/metrics/recording/test_permit_denials.py`<br>`tests/infra/metrics/recording/test_snapshot.py`<br>`docs/` 全般 | 1. リポジトリから単一ファイル版メトリクスレポートテストが除去されていることを確認し、`git ls-files` の結果を記録する。<br>2. `rg "test_success_events\|test_delay_events\|test_failures\|test_permit_denials\|test_snapshot" tests/infra/metrics docs/` の結果が分割テスト構成のみであることを確認し、結果を TASKS.md へ記録する。<br>3. CI (`pytest`, `mypy`, `ruff`) が分割テスト構成でグリーンであることを最終確認し、ドキュメントへ撤去完了手順を残す。<br>4. バックログと関連ドキュメントを更新し、撤去完了日とフォローアップ不要である旨を共有する。 | 2025-10-19: 旧ファイル撤去と記録更新を完了。 | OPS-B05 |
| [x] | OPS-B16 | メトリクス集計レコード分離と状態層整理 | `src/llm_generic_bot/infra/metrics/aggregator_state.py`<br>`src/llm_generic_bot/infra/metrics/aggregator_records.py`<br>`tests/infra/metrics/recording/test_success_events.py`<br>`tests/infra/metrics/recording/test_delay_events.py` | 1. `_SendEventRecord` などの純粋関数を新設ファイルへ移し、状態層はバックエンド委譲のみに絞る。<br>2. `pytest tests/infra/metrics/recording/test_success_events.py -q`・`pytest tests/infra/metrics/recording/test_delay_events.py -q`・`mypy src/llm_generic_bot/infra/metrics`・`ruff check src/llm_generic_bot/infra/metrics` を順に実行して回帰を防ぐ。 | 2025-10-24: `src/llm_generic_bot/infra/metrics/aggregator_state.py`／`aggregator_records.py` の分離後も上記テストと型/リンタがグリーンであることを `tests/infra/metrics/test_send_delay_thresholds.py` と併せて確認済み。 | - |
| [x] | UX-B01 | Engagement 指標の長期トレンド分析と調整方針 | `src/llm_generic_bot/features/weather.py`<br>`src/llm_generic_bot/core/orchestrator/_legacy.py`<br>`src/llm_generic_bot/core/orchestrator/processor.py`<br>`tests/features/weather_engagement/test_scoring.py::test_weather_engagement_long_term_trend_blends_recent_history`<br>`tests/features/weather_engagement/test_scoring.py::test_weather_engagement_trend_respects_permit_quota_variation`<br>`tests/features/weather_engagement/test_resume_conditions.py::test_weather_engagement_resume_thresholds`<br>`tests/features/weather_engagement/test_cooldown.py::test_send_success_log_contains_engagement` | 1. `pytest tests/features/weather_engagement/test_scoring.py::test_weather_engagement_long_term_trend_blends_recent_history -q` と `pytest tests/features/weather_engagement/test_scoring.py::test_weather_engagement_trend_respects_permit_quota_variation -q` で履歴ブレンドと Permit クォータ補正を固定する。<br>2. `pytest tests/features/weather_engagement/test_resume_conditions.py::test_weather_engagement_resume_thresholds -q` と `pytest tests/features/weather_engagement/test_cooldown.py::test_send_success_log_contains_engagement -q` で停止・再開境界と送信ログのタグ記録を確認し、`tests/core/orchestrator_send/test_success_flow.py::test_process_success_records` と `tests/infra/metrics/recording/test_success_events.py::test_report_send_success_records_engagement_tags` でメトリクス記録を回帰。 | 2025-10-20: Weather Engagement 長期平均ブレンドと Permit クォータタグ連携を実装し、`tests/features/weather_engagement/test_scoring.py`・`test_resume_conditions.py`・`test_cooldown.py` 参照へ更新済み。 | [UX-05] Weather Engagement 長期トレンド補正（ロードマップ参照）。 |
| [x] | DOC-B08 | runtime_multicontent の DM ダイジェスト節を現行実装へ同期 | `docs/roadmap.md`<br>`docs/tasks/backlog.md` | 1. `docs/roadmap.md` で DM ダイジェスト統合テストの説明を更新し、`tests/integration/runtime_multicontent/test_pipeline_dm_digest.py::test_dm_digest_job_registers_without_enqueue` と `tests/integration/runtime_multicontent/test_dm_digest.py::test_dm_digest_job_sends_without_scheduler_queue` が sender 直接送信と dispatch 非発火を担保していることを明文化する。<br>2. 更新内容をバックログへ反映するため、本ファイルの Frontmatter `updated` 日付と DM ダイジェスト関連タスクの備考を調整し、差分確認後に `markdownlint docs/roadmap.md`・`markdownlint docs/tasks/backlog.md` を実行する。<br>3. `git diff` で意図しない変更が混入していないことを確認する。 | 2025-10-18: ドキュメント更新・整形確認を完了し、バックログを同期済み。ロードマップ側でテスト説明を同期済み。 | OPS-B07 |
| [x] | DOC-B09 | 週次サマリ節のテンプレート差分説明を補完 | `docs/roadmap.md` | 1. `tests/integration/runtime_weekly_report/test_templates.py`・`test_scheduler.py`・`test_fallbacks.py` で保証しているテンプレート整形/曜日スケジュール/自己成功率除外の内容を再確認し、`docs/roadmap.md` の該当節へ不足している検証観点（テンプレート差分ハイライトや fallback 経路）を追記する。<br>2. `markdownlint docs/roadmap.md` を実行し、書式崩れがないことを確認する。<br>3. `git diff docs/roadmap.md` で意図した差分のみになっていることを確認する。 | 2025-10-18: 完了・同期済み。 | OPS-B02 |
| [x] | DOC-B10 | デデュープ無効化テストと cooldown.jobs 検証のロードマップ反映 | `docs/roadmap.md` | 1. ロードマップにデデュープ無効化テストの検証観点を追記する。<br>2. 同じく cooldown.jobs 検証内容を整理し、ロードマップへ反映する。<br>3. 上記 2 テスト（デデュープ無効化テスト、cooldown.jobs 検証）を完了条件として明記し、`markdownlint docs/roadmap.md` を実行して整形崩れがないことを確認する。 | 2025-10-17: 本行追加。<br>2025-10-18: ロードマップへデデュープ無効化テストと cooldown.jobs 検証内容を反映し、整形確認まで完了。<br>2025-10-18: バックログ完了状態を確認し備考を整備。 | OPS-B07 |
| [x] | DOC-B11 | Weather キャッシュローテーション/週次サマリ設定テスト反映 | `docs/roadmap.md` | Weather キャッシュローテーションと週次サマリ設定テストの反映が完了し、ロードマップへ検証観点が整備されている。 | 関連テスト: `tests/features/test_weather_cache_rotation.py`、`tests/features/test_report.py`、`tests/config/test_settings_example_report.py`。検証: `pytest tests/features/test_weather_cache_rotation.py tests/features/test_report.py tests/config/test_settings_example_report.py -q` を実行して反映内容を確認する。<br>完了日: 2025-10-18。`docs/roadmap.md` 反映済み。 | OPS-B07 |
| [x] | DOC-B12 | 構造化ログ節のロードマップ同期 | `docs/roadmap.md` | `docs/roadmap.md` の構造化ログ節を `tests/core/structured_logging/test_*.py` 群の最新仕様へ同期し、成功/失敗/Permit/重複/メトリクス各モジュールの検証観点を明文化する。 | 関連テスト: `tests/core/structured_logging/test_success.py`、`test_failure.py`、`test_permit.py`、`test_duplicate.py`、`test_metrics.py`。テスト先行実行: `pytest tests/core/structured_logging -q` を完了条件に含める。完了日: 2025-10-18。`tests/core/structured_logging/test_*.py` 群と同期済みでロードマップ側へ反映済み。 | OPS-B07 |
| [x] | DOC-B13 | DOC-B14 参照修正 | `docs/roadmap.md` | `docs/roadmap.md` の該当節を確認し、`tests/adapters/test_retry_policy.py::test_max_attempts` の検証手順が最新化されていることを確かめる。完了条件として `pytest tests/adapters/test_retry_policy.py::test_max_attempts -q` を実行する。 | 完了日: 2025-10-18。確認コマンド: `pytest tests/adapters/test_retry_policy.py::test_max_attempts -q`。SND-01 節を再確認し、検証手順の最新化を維持。 | DOC-B14 |
| [x] | DOC-B14 | SND-01 RetryPolicy の test_max_attempts 同期 | `docs/roadmap.md` | ロードマップの SND-01 節を `tests/adapters/test_retry_policy.py::test_max_attempts` の仕様に揃え、検証手順として `pytest tests/adapters/test_retry_policy.py::test_max_attempts -q` 実行を明記する。 | Sprint1 SND-01 の記述が retry 最大試行検証へ追随していないため、`test_max_attempts` 観点で同期する更新。完了日: 2025-10-18。`docs/roadmap.md` 反映済み。<br>2025-10-18: DOC-B12/DOC-B13 の重複を DOC-B14 へ統合済み。 | SND-01 |
| [x] | DOC-B15 | send.delay_seconds の秒単位タグ記述をロードマップへ追加 | `docs/roadmap.md` | 1. `docs/roadmap.md` の「残課題 > OPS（運用・基盤）」節へ `send.delay_seconds` が `unit=seconds` タグ付きで報告される旨と検証コマンドを追記する（参照: [`docs/roadmap.md#ops運用・基盤`](../roadmap.md#ops運用・基盤)）。<br>2. `pytest tests/infra/metrics/recording/test_delay_events.py -q` を実行して記述内容の検証観点を確認する。<br>3. 更新後に `markdownlint docs/roadmap.md` を実行し、書式崩れがないことを確認する。 | 2025-10-21: `infra.metrics.reporting.report_send_delay` への言及を追加し、`pytest ... -k report_send_delay_records_unit_seconds -q` / `npx markdownlint-cli docs/tasks/backlog.md` を再実行して整合を確認。<br>2025-10-20: ロードマップへ `report_send_delay` 起点の `unit="seconds"` 記述と `pytest ... -k report_send_delay_records_unit_seconds -q` コマンドを反映し、`npx markdownlint-cli docs/tasks/backlog.md` を実行して整形を確認。 | - |

## 進行手順

1. 各残課題について、テストケースを先に作成し現状挙動を固定する。
2. テスト結果をもとに設定値やフローを調整し、`pytest`, `mypy src`, `ruff check .` を順に実行して回帰を防ぐ。
3. 設定変更は `config/settings.example.json` への反映とリリースノート下書きを忘れず、完了後は当表のチェックボックスを更新する。
